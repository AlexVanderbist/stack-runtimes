---
kind: pipeline
name: php-7.3

platform:
  os: linux
  arch: amd64

clone:
  depth: 0
  tags: true

steps:
- name: build
  pull: always
  image: quay.io/presslabs/bfc
  environment:
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
  commands:
    - make pull-cache
    - make images
  volumes:
  - name: dockersock
    path: /var/run

- name: test php image
  image: quay.io/presslabs/bfc
  depends_on: [build]
  environment:
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
  commands:
    - make .build/test/php
  volumes:
  - name: dockersock
    path: /var/run

- name: test wordpress image
  image: quay.io/presslabs/bfc
  depends_on: [build]
  environment:
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
  commands:
    - make .build/test/wordpress
  volumes:
  - name: dockersock
    path: /var/run

- name: publish
  depends_on:
    - test php image
    - test wordpress image
  image: quay.io/presslabs/bfc
  environment:
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
    DOCKER_USER: "presslabs+drone"
    DOCKER_PASSWORD:
      from_secret: QUAY_TOKEN
  commands:
    - docker login -u="$DOCKER_USER" -p="$DOCKER_PASSWORD" quay.io
    - make push-images
  volumes:
  - name: dockersock
    path: /var/run

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run

volumes:
- name: dockersock
  temp: {}


