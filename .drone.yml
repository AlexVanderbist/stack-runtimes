---
kind: pipeline
name: php-7.3

platform:
  os: linux
  arch: amd64

clone:
  depth: 0
  tags: true

steps:
- name: build
  pull: always
  image: quay.io/presslabs/bfc
  environment: &baseEnv
    PHP_VERSION: 7.3.7
    TAG_SUFFIX: ${DRONE_BRANCH/master/}
  commands:
    - make pull-cache
    - make images
  volumes:
  - name: dockersock
    path: /var/run

- name: test php image
  image: quay.io/presslabs/bfc
  depends_on: [build]
  environment:
    <<: *baseEnv
  commands:
    - make .build/test/php
  volumes:
  - name: dockersock
    path: /var/run

- name: test wordpress image
  image: quay.io/presslabs/bfc
  depends_on: [build]
  environment:
    <<: *baseEnv
  commands:
    - make .build/test/wordpress
  volumes:
  - name: dockersock
    path: /var/run

- name: publish on stage
  depends_on:
    - test php image
    - test wordpress image
  image: quay.io/presslabs/bfc
  environment:
    <<: *baseEnv
    TAG_SUFFIX: ${DRONE_COMMIT_SHA:0:7}
    DOCKER_USER: "presslabs+drone"
    DOCKER_PASSWORD:
      from_secret: QUAY_TOKEN
  commands:
    - docker login -u="$DOCKER_USER" -p="$DOCKER_PASSWORD" quay.io
    - make push-images
  volumes:
  - name: dockersock
    path: /var/run

services:
- name: docker
  image: docker:dind
  privileged: true
  volumes:
  - name: dockersock
    path: /var/run
- name: mysql
  image: percona:5.7
  environment:
    MYSQL_ROOT_PASSWORD: not-so-secure
    MYSQL_DATABASE: wordpress

volumes:
- name: dockersock
  temp: {}
